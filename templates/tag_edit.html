{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - {{ tag.name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h3 mb-2">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω–Ω–∏–∫–∞</h1>
        <p class="text-muted mb-0">ID: {{ tag.id }} - {{ tag.name }}</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="/tag/{{ tag.id }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i> –ù–∞–∑–∞–¥ –∫ —Ü–µ–Ω–Ω–∏–∫—É
        </a>
    </div>
</div>

<!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ ESP32 -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
<div class="row mb-4">
    <div class="col-12">
        {% for category, message in messages %}
        {% if 'ESP32' in message or '–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω' in message or '–æ—à–∏–±–∫–∞' in message or '–ø–æ–¥–∫–ª—é—á–µ–Ω–∏' in message %}
        <div class="alert alert-{{ 'success' if '‚úÖ' in message or '—É—Å–ø–µ—à' in message else 'warning' if '‚ö†Ô∏è' in message else 'danger' }} alert-dismissible fade show d-flex align-items-center" role="alert">
            <div class="me-3">
                {% if '‚úÖ' in message or '—É—Å–ø–µ—à' in message %}
                <i class="fas fa-check-circle fa-2x"></i>
                {% elif '‚ö†Ô∏è' in message %}
                <i class="fas fa-exclamation-triangle fa-2x"></i>
                {% elif '‚ùå' in message or '–æ—à–∏–±–∫–∞' in message %}
                <i class="fas fa-times-circle fa-2x"></i>
                {% elif 'üì°' in message %}
                <i class="fas fa-wifi fa-2x"></i>
                {% else %}
                <i class="fas fa-info-circle fa-2x"></i>
                {% endif %}
            </div>
            <div class="flex-grow-1">
                <h5 class="alert-heading mb-1">
                    {% if 'ESP32' in message %}–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ ESP32{% else %}–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ{% endif %}
                </h5>
                <div class="mb-0">{{ message|safe }}</div>
                {% if 'IP:' in message %}
                <small class="text-muted d-block mt-1">
                    <i class="fas fa-network-wired me-1"></i> {{ tag.esp_ip }}
                </small>
                {% endif %}
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>
  {% endif %}
{% endwith %}

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
            </div>
            <div class="card-body">
                <form id="editTagForm" method="POST" action="/tag/{{ tag.id }}/edit">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
                            <input type="text" class="form-control" name="name"
                                   value="{{ tag.name }}" required id="productName">
                            <div class="form-text">–ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ ESP32</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–¶–µ–Ω–∞ (‚ÇΩ) *</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="current_price"
                                       value="{{ tag.current_price }}" step="0.01" min="0" required id="currentPrice">
                                <span class="input-group-text">‚ÇΩ</span>
                            </div>
                            <div class="form-text">–ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ ESP32</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–í–µ—Å (–∫–≥) *</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="weight"
                                       value="{{ tag.weight }}" step="0.001" min="0" required id="productWeight">
                                <span class="input-group-text">–∫–≥</span>
                            </div>
                            <div class="form-text">–ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ ESP32</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <input type="text" class="form-control" name="change_reason"
                                   placeholder="–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã, –∞–∫—Ü–∏—è..." id="changeReason">
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="/tag/{{ tag.id }}" class="btn btn-secondary me-2">
                            <i class="fas fa-times me-2"></i> –û—Ç–º–µ–Ω–∞
                        </a>
                        <button type="submit" class="btn btn-primary" id="saveButton">
                            <i class="fas fa-save me-2"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ESP32</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ:</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="fas fa-microchip me-2 text-primary"></i>
                                <strong>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ID:</strong> {{ tag.id }}
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-network-wired me-2 text-primary"></i>
                                <strong>IP –∞–¥—Ä–µ—Å:</strong> {{ tag.esp_ip }}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted d-block">ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:</small>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-hashtag me-2 text-muted"></i>
                        <strong class="font-monospace">{{ tag.id }}</strong>
                    </div>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block">IP –∞–¥—Ä–µ—Å ESP32:</small>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-network-wired me-2 text-muted"></i>
                        <strong class="font-monospace">{{ tag.esp_ip }}</strong>
                        <button type="button" class="btn btn-sm btn-link ms-2" onclick="copyToClipboard('{{ tag.esp_ip }}')" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å IP">
                            <i class="far fa-copy"></i>
                        </button>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ESP -->
                <div class="mt-4 pt-3 border-top">
                    <h6 class="mb-3">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ESP32:</h6>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-warning" onclick="showESPInfo()">
                            <i class="fas fa-info-circle me-2"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–°—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted">–ó–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏:</small><br>
                    <div class="d-flex align-items-center">
                        {% if tag.battery_level < 20 %}
                        <span class="text-danger me-2">
                            <i class="fas fa-battery-empty"></i>
                        </span>
                        <strong class="text-danger">{{ tag.battery_level }}%</strong>
                        {% elif tag.battery_level < 50 %}
                        <span class="text-warning me-2">
                            <i class="fas fa-battery-quarter"></i>
                        </span>
                        <strong class="text-warning">{{ tag.battery_level }}%</strong>
                        {% else %}
                        <span class="text-success me-2">
                            <i class="fas fa-battery-full"></i>
                        </span>
                        <strong class="text-success">{{ tag.battery_level }}%</strong>
                        {% endif %}
                        <div class="progress flex-grow-1 ms-2" style="height: 8px;">
                            <div class="progress-bar bg-{{ 'danger' if tag.battery_level < 20 else 'warning' if tag.battery_level < 50 else 'success' }}"
                                 role="progressbar" style="width: {{ tag.battery_level }}%;"></div>
                        </div>
                    </div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</small><br>
                    <strong>
                        {% if tag.last_seen %}
                        {{ tag.last_seen[11:16] }} ({{ tag.last_seen[:10] }})
                        {% else %}
                        –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                        {% endif %}
                    </strong>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ JSON
function updatePreview() {
    const data = {
        device_id: "{{ tag.id }}",
        product_name: document.getElementById('productName').value,
        current_price: parseFloat(document.getElementById('currentPrice').value),
        weight: parseFloat(document.getElementById('productWeight').value),
        battery: parseInt("{{ tag.battery_level }}"),
        is_active: true
    };

    document.getElementById('espPreview').textContent = JSON.stringify(data, null, 2);
}

// –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ESP32
function testESPConnection() {
    const tagId = "{{ tag.id }}";
    const button = event?.target || document.querySelector('[onclick*="testESPConnection"]');

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
    button.disabled = true;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showNotification('info', '–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ESP32...');

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    fetch(`/api/esp/test/${tagId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('success',
                    `‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ESP32 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!<br>
                     IP: ${data.ip_address}<br>
                     –°—Ç–∞—Ç—É—Å: HTTP ${data.status_code}`);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showNotification('error',
                    `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ ESP32<br>
                     IP: ${data.ip_address}<br>
                     –û—à–∏–±–∫–∞: ${data.message}`);
            }
        })
        .catch(error => {
            showNotification('error',
                `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:<br>${error}`);
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ ESP32
function sendTestData() {
    const tagId = "{{ tag.id }}";
    const testData = {
        product_name: "–¢–ï–°–¢: " + document.getElementById('productName').value,
        current_price: 77.77,
        weight: 0.777,
        test: true
    };

    showNotification('info', '–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ ESP32...');

    fetch(`/api/esp/send-test/${tagId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(testData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success',
                `‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!<br>
                 IP: ${data.ip_address}<br>
                 –°—Ç–∞—Ç—É—Å: HTTP ${data.status_code}`);
        } else {
            showNotification('warning',
                `‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–∞:<br>
                 ${data.message}`);
        }
    })
    .catch(error => {
        showNotification('error',
            `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ—Å—Ç–∞:<br>${error}`);
    });
}

// –ü–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± ESP32
function showESPInfo() {
    const info = `
        <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</h5>
        <table class="table table-sm">
            <tr>
                <td><strong>ID:</strong></td>
                <td>{{ tag.id }}</td>
            </tr>
            <tr>
                <td><strong>IP –∞–¥—Ä–µ—Å:</strong></td>
                <td>{{ tag.esp_ip }}</td>
            </tr>
            <tr>
                <td><strong>–¢–µ–∫—É—â–∏–π —Ç–æ–≤–∞—Ä:</strong></td>
                <td>{{ tag.name }}</td>
            </tr>
            <tr>
                <td><strong>–¶–µ–Ω–∞:</strong></td>
                <td>{{ tag.current_price }} ‚ÇΩ</td>
            </tr>
            <tr>
                <td><strong>–í–µ—Å:</strong></td>
                <td>{{ tag.weight }} –∫–≥</td>
            </tr>
            <tr>
                <td><strong>–ó–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏:</strong></td>
                <td>{{ tag.battery_level }}%</td>
            </tr>
            <tr>
                <td><strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong></td>
                <td>{% if tag.last_seen %}{{ tag.last_seen[11:16] }} ({{ tag.last_seen[:10] }}){% else %}–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö{% endif %}</td>
            </tr>
        </table>
        <p class="text-muted small">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.</p>
    `;

    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modalHTML = `
        <div class="modal fade" id="infoModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${info}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –º–æ–¥–∞–ª–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
    const oldModal = document.getElementById('infoModal');
    if (oldModal) oldModal.remove();

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
    const modal = new bootstrap.Modal(document.getElementById('infoModal'));
    modal.show();
}

// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    updatePreview();

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
    ['productName', 'currentPrice', 'productWeight'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updatePreview);
            element.addEventListener('change', updatePreview);
        }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    const saveButton = document.getElementById('saveButton');
    if (saveButton) {
        saveButton.addEventListener('click', function(e) {
            if (document.getElementById('editTagForm').checkValidity()) {
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
                saveButton.disabled = true;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showNotification('info', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ ESP32...');
            }
        });
    }
});
</script>

<style>
    #espPreview {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        white-space: pre-wrap;
        word-break: break-all;
    }

    .alert .fa-2x {
        font-size: 1.5em;
    }

    .position-fixed {
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .battery-progress {
        height: 8px;
        border-radius: 4px;
    }
</style>
{% endblock %}