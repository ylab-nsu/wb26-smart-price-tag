{% extends "base.html" %}

{% block title %}Главная - Электронные ценники{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h3 mb-2">Система управления электронными ценниками</h1>
        <p class="text-muted mb-0">Мониторинг и управление ESP32 ценниками в реальном времени</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="/tags" class="btn btn-primary">
            <i class="fas fa-tags me-2"></i> Все ценники
        </a>
        <a href="/about" class="btn btn-outline-secondary">
            <i class="fas fa-info-circle me-2"></i> О системе
        </a>
    </div>
</div>

<!-- Статистика с кликабельными карточками -->
<div class="row mb-4">
    <div class="col-md-4">
        <a href="/tags" class="text-decoration-none">
            <div class="card stat-card">
                <div class="stat-icon text-primary">
                    <i class="fas fa-tags"></i>
                </div>
                <div class="stat-value">{{ total_tags }}</div>
                <div class="stat-label">Всего ценников</div>
            </div>
        </a>
    </div>
</div>

<!-- Все доступные ценники -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-microchip me-2"></i>Все доступные ценники
                </h5>
                <span class="badge bg-primary">{{ PRICE_TAGS|length }} устройств</span>
            </div>
            <div class="card-body">
                {% if PRICE_TAGS and PRICE_TAGS|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Название</th>
                                <th>Цена</th>
                                <th>Вес</th>
                                <th>Заряд батареи</th>
                                <th>IP устройства</th>
                                <th>Последнее обновление</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tag in PRICE_TAGS %}
                            <tr>
                                <td>
                                    <code>{{ tag.id }}</code>
                                </td>
                                <td>
                                    <strong>{{ tag.name }}</strong>
                                </td>
                                <td>
                                    <strong class="text-success">{{ "%.2f"|format(tag.current_price) }} ₽</strong>
                                </td>
                                <td>
                                    {{ tag.weight }} кг
                                </td>
                                <td>
                                    {% if tag.battery_level < 20 %}
                                    <span class="text-danger">
                                        <i class="fas fa-battery-empty me-1"></i>
                                        {{ tag.battery_level }}%
                                    </span>
                                    {% elif tag.battery_level < 50 %}
                                    <span class="text-warning">
                                        <i class="fas fa-battery-quarter me-1"></i>
                                        {{ tag.battery_level }}%
                                    </span>
                                    {% else %}
                                    <span class="text-success">
                                        <i class="fas fa-battery-full me-1"></i>
                                        {{ tag.battery_level }}%
                                    </span>
                                    {% endif %}
                                    <div class="progress mt-1" style="height: 4px;">
                                        <div class="progress-bar bg-{{ 'danger' if tag.battery_level < 20 else 'warning' if tag.battery_level < 50 else 'success' }}"
                                             role="progressbar" style="width: {{ tag.battery_level }}%;"></div>
                                    </div>
                                </td>
                                <td>
                                    <code class="text-muted">{{ tag.esp_ip }}</code>
                                </td>
                                <td>
                                    {% if tag.last_seen %}
                                    <div class="last-seen">
                                        <strong>{{ tag.last_seen[11:16] }}</strong><br>
                                        <small class="text-muted">{{ tag.last_seen[:10] }}</small>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">Нет данных</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/tag/{{ tag.id }}" class="btn btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="/tag/{{ tag.id }}/edit" class="btn btn-outline-success">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-outline-info" onclick="testESPConnection({{ tag.id }})" title="Проверить соединение">
                                            <i class="fas fa-wifi"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Нет ценников в системе</p>
                    <a href="/tags" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i> Добавить ценник
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Управление ESP32 -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-wifi me-2"></i>Управление ESP32
                </h5>
            </div>
            <div class="card-body">
                {% if PRICE_TAGS and PRICE_TAGS|length > 0 %}
                {% set tag = PRICE_TAGS[0] %}
                <div class="row">
                    <div class="col-md-6">
                        <h6>Тестирование соединения:</h6>
                        <p class="text-muted">Проверка связи с ESP32 устройством</p>
                        <button class="btn btn-outline-primary" onclick="testESPConnection({{ tag.id }})">
                            <i class="fas fa-sync-alt me-2"></i> Проверить соединение
                        </button>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <p class="text-muted">Нет устройства для управления</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Функция для проверки соединения с ESP32
    function testESPConnection(tagId) {
        const button = event?.target;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;

        showNotification('info', `Проверяем соединение с ценником ID: ${tagId}...`);

        fetch(`/api/esp/test/${tagId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('success',
                        `✅ Ценник ID: ${tagId} - соединение установлено!<br>
                         IP: ${data.ip_address}<br>
                         Статус: HTTP ${data.status_code}`);

                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification('error',
                        `❌ Ценник ID: ${tagId} - не удалось подключиться<br>
                         IP: ${data.ip_address}<br>
                         Ошибка: ${data.message}`);
                }
            })
            .catch(error => {
                showNotification('error',
                    `❌ Ошибка при тестировании ценника ID: ${tagId}<br>${error}`);
            })
            .finally(() => {
                if (button) {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }
            });
    }

    // Функция для отправки тестовых данных
    function sendTestData(tagId) {
        const testData = {
            product_name: "ТЕСТОВЫЙ ТОВАР",
            current_price: 77.77,
            weight: 0.777
        };

        showNotification('info', `Отправка тестовых данных на ценник ID: ${tagId}...`);

        fetch(`/api/esp/send-test/${tagId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(testData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('success',
                        `✅ Тестовые данные отправлены на ценник ID: ${tagId}!<br>
                     IP: ${data.ip_address}<br>
                     Статус: HTTP ${data.status_code}`);
                } else {
                    showNotification('warning',
                        `⚠️ Ошибка отправки теста на ценник ID: ${tagId}<br>
                     ${data.message}`);
                }
            })
            .catch(error => {
                showNotification('error',
                    `❌ Ошибка при отправке теста на ценник ID: ${tagId}<br>${error}`);
            });
    }
</script>
{% endblock %}