{% extends "base.html" %}

{% block title %}{{ tag.name }} - Электронные ценники{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h3 mb-2">{{ tag.name }}</h1>
        <p class="text-muted mb-0">Детальная информация о ценнике ID: {{ tag.id }}</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="/" class="btn btn-outline-secondary me-2">
            <i class="fas fa-home me-2"></i> На главную
        </a>
        <a href="/tags" class="btn btn-secondary me-2">
            <i class="fas fa-list me-2"></i> Все ценники
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Основная информация -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Основная информация</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <small class="text-muted">ID ценника:</small><br>
                            <strong><code>{{ tag.id }}</code></strong>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Название товара:</small><br>
                            <strong>{{ tag.name }}</strong>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">IP устройства:</small><br>
                            <strong>{{ tag.esp_ip }}</strong>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <small class="text-muted">Текущая цена:</small><br>
                            <strong class="text-success" style="font-size: 1.5rem;">{{ "%.2f"|format(tag.current_price) }} ₽</strong>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Вес товара:</small><br>
                            <strong>{{ tag.weight }} кг</strong>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Последнее обновление:</small><br>
                            <strong>
                                {% if tag.last_seen %}
                                {{ tag.last_seen[11:16] }}<br>
                                <small class="text-muted">{{ tag.last_seen[:10] }}</small>
                                {% else %}
                                <span class="text-muted">Нет данных</span>
                                {% endif %}
                            </strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Управление ESP32 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Управление ESP32 устройством</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Проверка соединения:</h6>
                        <p class="text-muted">Проверка доступности устройства</p>
                        <button class="btn btn-outline-primary" onclick="testESPConnection({{ tag.id }})">
                            <i class="fas fa-sync-alt me-2"></i> Проверить соединение
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6>Информация об устройстве:</h6>
                        <p class="text-muted">IP: <strong>{{ tag.esp_ip }}</strong></p>
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('{{ tag.esp_ip }}')">
                            <i class="far fa-copy me-1"></i> Копировать IP
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Статус устройства -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Статус устройства</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Заряд батареи:</small>
                    {% if tag.battery_level < 20 %}
                    <span class="text-danger">
                        <i class="fas fa-battery-empty me-1"></i>
                        {{ tag.battery_level }}%
                    </span>
                    {% elif tag.battery_level < 50 %}
                    <span class="text-warning">
                        <i class="fas fa-battery-quarter me-1"></i>
                        {{ tag.battery_level }}%
                    </span>
                    {% else %}
                    <span class="text-success">
                        <i class="fas fa-battery-full me-1"></i>
                        {{ tag.battery_level }}%
                    </span>
                    {% endif %}
                </div>
                <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar bg-{{ 'danger' if tag.battery_level < 20 else 'warning' if tag.battery_level < 50 else 'success' }}"
                         role="progressbar" style="width: {{ tag.battery_level }}%;"></div>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Последнее обновление:</small>
                    <div>
                        {% if tag.last_seen %}
                        <strong>{{ tag.last_seen[11:16] }}</strong><br>
                        <small class="text-muted">{{ tag.last_seen[:10] }}</small>
                        {% else %}
                        <span class="text-muted">Нет данных</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Быстрые действия -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Действия</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/tags" class="btn btn-outline-primary">
                        <i class="fas fa-list me-2"></i> Все ценники
                    </a>
                    <a href="/tag/{{ tag.id }}/edit" class="btn btn-primary">
                        <i class="fas fa-edit me-2"></i> Редактировать
                    </a>
                    <button type="button" onclick="refreshTag({{ tag.id }})" class="btn btn-outline-success">
                        <i class="fas fa-sync-alt me-2"></i> Обновить статус
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Функция для проверки соединения с ESP32
    function testESPConnection(tagId) {
        const button = event?.target;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Проверка...';
        button.disabled = true;

        showNotification('info', 'Проверяем соединение с ESP32...');

        fetch(`/api/esp/test/${tagId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('success',
                        `✅ Соединение с ESP32 установлено!<br>
                         IP: ${data.ip_address}<br>
                         Статус: HTTP ${data.status_code}`);

                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification('error',
                        `❌ Не удалось подключиться к ESP32<br>
                         IP: ${data.ip_address}<br>
                         Ошибка: ${data.message}`);
                }
            })
            .catch(error => {
                showNotification('error',
                    `❌ Ошибка при тестировании:<br>${error}`);
            })
            .finally(() => {
                button.innerHTML = originalHTML;
                button.disabled = false;
            });
    }

    // Функция для отправки тестовых данных
    function sendTestData(tagId) {
        const testData = {
            product_name: "ТЕСТОВЫЙ ТОВАР",
            current_price: 77.77,
            weight: 0.777
        };

        showNotification('info', 'Отправка тестовых данных на ESP32...');

        fetch(`/api/esp/send-test/${tagId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(testData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('success',
                        `✅ Тестовые данные отправлены!<br>
                     IP: ${data.ip_address}<br>
                     Статус: HTTP ${data.status_code}`);
                } else {
                    showNotification('warning',
                        `⚠️ Ошибка отправки теста:<br>
                     ${data.message}`);
                }
            })
            .catch(error => {
                showNotification('error',
                    `❌ Ошибка при отправке теста:<br>${error}`);
            });
    }

    function refreshTag(tagId) {
        testESPConnection(tagId);
    }
</script>
{% endblock %}